{% block price_template_create %}
    <sw-page class="price-template-create">
        <template #smart-bar-header>
            <h2>{{ isEdit ? $tc('supplier.priceUpdate.wizard.titleEdit') : $tc('supplier.priceUpdate.wizard.title') }}</h2>
        </template>

        <template #smart-bar-actions>
            <sw-button :routerLink="{ name: 'supplier.price.update.index' }">
                {{ $tc('supplier.priceUpdate.wizard.buttonCancel') }}
            </sw-button>
            <sw-button
                v-if="currentStep > 1"
                @click="previousStep"
            >
                {{ $tc('supplier.priceUpdate.wizard.buttonBack') }}
            </sw-button>
            <sw-button
                v-if="currentStep < 3"
                variant="primary"
                :disabled="!canProceedToNextStep"
                @click="nextStep"
            >
                {{ $tc('supplier.priceUpdate.wizard.buttonNext') }}
            </sw-button>
            <sw-button-process
                v-if="isEdit"
                variant="primary"
                :isLoading="isSaving"
                :processSuccess="saveSuccess"
                @process-finish="saveFinish"
                @click="onSave"
                class="price-template-create__save-button"
            >
                {{ $tc('supplier.priceUpdate.wizard.buttonSave') }}
            </sw-button-process>
        </template>

        <template #content>
            <sw-loader v-if="isLoading" />

            <div v-else-if="template" class="price-template-wizard">
                <!-- Step Indicator -->
                <sw-card class="wizard-steps">
                    <div class="step-indicator">
                        <div
                            v-for="step in 3"
                            :key="step"
                            class="step"
                            :class="{ active: step === currentStep, completed: step < currentStep }"
                        >
                            <div class="step-number">{{ step }}</div>
                            <div class="step-label">{{ $tc(`supplier.priceUpdate.wizard.step${step}Label`) }}</div>
                        </div>
                    </div>
                </sw-card>

                <!-- Step 1: Basic Information -->
                <sw-card v-if="currentStep === 1" :title="$tc('supplier.priceUpdate.wizard.step1Title')">
                    <sw-text-field
                        v-model:value="template.name"
                        :label="$tc('supplier.priceUpdate.wizard.labelName')"
                        required
                    />

                    <sw-entity-single-select
                        v-model:value="template.supplierId"
                        entity="art_supplier"
                        :label="$tc('supplier.priceUpdate.wizard.labelSupplier')"
                        required
                    />
                </sw-card>

                <!-- Step 2: Price List Management -->
                <div v-if="currentStep === 2">
                    <!-- 2.1: Supplier Price Lists -->
                    <sw-card :title="$tc('supplier.priceUpdate.wizard.step2_1Title')">
                        <sw-upload-listener
                            :uploadTag="uploadTag"
                            autoUpload
                            @media-upload-finish="onMediaUploadFinish"
                        />

                        <sw-media-upload-v2
                            v-if="mediaFolderId"
                            variant="regular"
                            :uploadTag="uploadTag"
                            :label="$tc('supplier.priceUpdate.wizard.labelUploadFile')"
                            :target-folder-id="mediaFolderId"
                        />
                        <div v-else>
                            <sw-loader />
                        </div>

                        <sw-data-grid
                            v-if="supplierMediaItems.length > 0"
                            :dataSource="supplierMediaItems"
                            :columns="mediaColumns"
                            :showSelection="false"
                            class="supplier-media-grid">

                            <template #column-isActive="{ item }">
                                <sw-icon
                                    v-if="item.id === template.config.selected_media_id"
                                    name="regular-checkmark"
                                    color="#37d046"
                                />
                            </template>

                            <template #actions="{ item }">
                                <sw-context-menu-item
                                    v-if="item.id !== template.config.selected_media_id"
                                    @click="setActiveMedia(item)">
                                    {{ $tc('supplier.priceUpdate.wizard.buttonSelectActive') }}
                                </sw-context-menu-item>
                                <sw-context-menu-item
                                    variant="danger"
                                    @click="removeMediaFromSupplier(item)">
                                    {{ $tc('supplier.priceUpdate.wizard.buttonRemoveFile') }}
                                </sw-context-menu-item>
                            </template>
                        </sw-data-grid>
                    </sw-card>

                    <!-- 2.2: Preview & Column Mapping -->
                    <sw-card
                        v-if="template.config.selected_media_id"
                        :title="$tc('supplier.priceUpdate.wizard.step2_2Title')">

                        <sw-loader v-if="isLoadingPreview" />

                        <div v-if="filePreview" class="file-preview">
                            <table class="preview-table">
                                <thead>
                                    <tr>
                                        <th class="row-selector-column">
                                            {{ $tc('supplier.priceUpdate.wizard.columnStartRow') }}
                                        </th>
                                        <th v-for="(headerValue, colLetter) in filePreview.headers" :key="colLetter">
                                            <div class="column-header">
                                                <strong>{{ colLetter }}</strong>
                                                <sw-multi-select
                                                    :value="getColumnMapping(colLetter)"
                                                    @update:value="updateColumnMapping(colLetter, $event)"
                                                    :options="getAvailableColumnTypes(colLetter)"
                                                    size="small"
                                                    labelProperty="label"
                                                    valueProperty="value"
                                                />
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(row, rowIdx) in filePreview.rows"
                                        :key="rowIdx"
                                        :class="getRowClass(rowIdx + 1)">
                                        <td class="row-selector-cell">
                                            <input
                                                type="radio"
                                                name="start_row"
                                                :value="rowIdx + 1"
                                                v-model="template.config.start_row"
                                                @change="onStartRowChange">
                                            <span>{{ rowIdx + 1 }}</span>
                                        </td>
                                        <td v-for="(cell, colLetter) in row" :key="colLetter">
                                            {{ cell }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </sw-card>

                    <!-- 2.3 & 2.4: Price Modifiers and Currencies -->
                    <sw-card
                        v-if="template.config.selected_media_id"
                        :title="$tc('supplier.priceUpdate.wizard.step2_3Title')">

                        <!-- Currencies -->
                        <div class="currency-selection">
                            <h4>{{ $tc('supplier.priceUpdate.wizard.currenciesTitle') }}</h4>

                            <div class="currency-row">
                                <sw-single-select
                                    v-model:value="template.config.price_currencies.purchase"
                                    :options="currencyOptions"
                                    :label="$tc('supplier.priceUpdate.wizard.labelPurchaseCurrency')"
                                    @update:value="autoSaveTemplate"
                                />

                                <sw-single-select
                                    v-model:value="template.config.price_currencies.retail"
                                    :options="currencyOptions"
                                    :label="$tc('supplier.priceUpdate.wizard.labelRetailCurrency')"
                                    @update:value="autoSaveTemplate"
                                />

                                <sw-single-select
                                    v-model:value="template.config.price_currencies.list"
                                    :options="currencyOptions"
                                    :label="$tc('supplier.priceUpdate.wizard.labelListCurrency')"
                                    @update:value="autoSaveTemplate"
                                />
                            </div>
                        </div>

                        <!-- Modifiers -->
                        <div class="modifiers-section">
                            <h4>{{ $tc('supplier.priceUpdate.wizard.modifiersTitle') }}</h4>

                            <div v-for="(modifier, idx) in template.config.modifiers" :key="idx" class="modifier-row">
                                <sw-single-select
                                    v-model:value="modifier.price_type"
                                    :options="getAvailablePriceTypes(idx)"
                                    :label="$tc('supplier.priceUpdate.wizard.labelPriceType')"
                                    @update:value="autoSaveTemplate"
                                />

                                <sw-single-select
                                    v-model:value="modifier.modifier_type"
                                    :options="modifierTypeOptions"
                                    :label="$tc('supplier.priceUpdate.wizard.labelModifierType')"
                                    @update:value="autoSaveTemplate"
                                />

                                <sw-number-field
                                    v-if="modifier.modifier_type !== 'none'"
                                    v-model:value="modifier.value"
                                    :label="$tc('supplier.priceUpdate.wizard.labelModifierValue')"
                                    @update:value="autoSaveTemplate"
                                    class="modifier-value-field"
                                />

                                <sw-button
                                    variant="danger"
                                    size="small"
                                    square
                                    @click="removeModifier(idx)">
                                    <sw-icon name="regular-times-s" small />
                                </sw-button>
                            </div>

                            <sw-button
                                v-if="canAddModifier"
                                @click="addModifier">
                                {{ $tc('supplier.priceUpdate.wizard.buttonAddModifier') }}
                            </sw-button>
                        </div>
                    </sw-card>
                </div>

                <!-- Step 3: Preview and Apply -->
                <div v-if="currentStep === 3">
                    <!-- Filters -->
                    <sw-card :title="$tc('supplier.priceUpdate.wizard.step3FiltersTitle')">
                        <sw-entity-single-select
                            v-model:value="template.config.filters.supplier"
                            entity="art_supplier"
                            :label="$tc('supplier.priceUpdate.wizard.labelFilterSupplier')"
                            @update:value="autoSaveTemplate"
                        />

                        <sw-entity-multi-id-select
                            :value="template.config.filters.categories"
                            @update:value="onCategoriesChange"
                            :repository="categoryRepository"
                            :criteria="categoryCriteria"
                            :label="$tc('supplier.priceUpdate.wizard.labelFilterCategories')"
                        />

                        <sw-entity-multi-id-select
                            :value="template.config.filters.manufacturers"
                            @update:value="onManufacturersChange"
                            :repository="manufacturerRepository"
                            :criteria="manufacturerCriteria"
                            :label="$tc('supplier.priceUpdate.wizard.labelFilterManufacturers')"
                        />

                        <sw-multi-select
                            :value="safeEquipmentTypeIds"
                            @update:value="onEquipmentTypesChange"
                            :label="$tc('supplier.priceUpdate.wizard.labelFilterEquipmentTypes')"
                            :placeholder="$tc('supplier.priceUpdate.wizard.placeholderEquipmentTypes')"
                            :options="equipmentTypeOptions"
                            labelProperty="label"
                            valueProperty="value"
                        />

                        <sw-single-select
                            v-model:value="template.config.filters.availability_action"
                            :options="availabilityActionOptions"
                            :label="$tc('supplier.priceUpdate.wizard.labelAvailabilityAction')"
                            @update:value="autoSaveTemplate"
                        />

                        <sw-checkbox-field
                            v-model:value="template.config.filters.zero_stock_for_missing"
                            :label="$tc('supplier.priceUpdate.wizard.labelZeroStockForMissing')"
                            @update:value="autoSaveTemplate"
                        />

                        <sw-button
                            variant="primary"
                            @click="loadMatchPreview"
                            :isLoading="isLoadingMatchPreview"
                            class="preview-button-spacing">
                            {{ $tc('supplier.priceUpdate.wizard.buttonPreview') }}
                        </sw-button>
                    </sw-card>

                    <!-- Match Preview Table -->
                    <sw-card
                        v-if="matchPreviewData && matchPreviewData.length > 0"
                        :title="$tc('supplier.priceUpdate.wizard.step3PreviewTitle')"
                        class="preview-table-card">

                        <!-- Statistics -->
                        <div class="preview-statistics">
                            <div class="stat-item">
                                <span class="stat-label">{{ $tc('supplier.priceUpdate.wizard.statMatched') }}:</span>
                                <span class="stat-value stat-matched">{{ previewStats.matched }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">{{ $tc('supplier.priceUpdate.wizard.statEdited') }}:</span>
                                <span class="stat-value stat-edited">{{ previewStats.edited }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">{{ $tc('supplier.priceUpdate.wizard.statUnmatched') }}:</span>
                                <span class="stat-value stat-unmatched">{{ previewStats.unmatched }}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">{{ $tc('supplier.priceUpdate.wizard.statTotal') }}:</span>
                                <span class="stat-value stat-total">{{ previewStats.total }}</span>
                            </div>
                        </div>

                        <div class="preview-actions" style="display: flex; align-items: center; gap: 8px;">
                            <template v-if="!isAutoMatching">
                                <input
                                    type="number"
                                    v-model.number="minMatchPercentage"
                                    :placeholder="$tc('supplier.priceUpdate.wizard.minMatchPercentage')"
                                    min="0"
                                    max="100"
                                    step="5"
                                    style="width: 70px; padding: 6px 8px; border: 1px solid #d1d9e0; border-radius: 4px; font-size: 14px;">

                                <sw-button @click="autoMatchProducts">
                                    {{ $tc('supplier.priceUpdate.wizard.buttonAutoMatch') }}
                                </sw-button>
                            </template>

                            <template v-else>
                                <sw-button
                                    @click="stopAutoMatch"
                                    variant="danger">
                                    {{ $tc('supplier.priceUpdate.wizard.buttonStopAutoMatch') }}
                                </sw-button>
                            </template>

                            <sw-button
                                @click="clearAllBindings"
                                variant="ghost">
                                {{ $tc('supplier.priceUpdate.wizard.buttonClearBindings') }}
                            </sw-button>

                            <sw-button
                                v-if="hasPendingMatches"
                                @click="confirmAllMatches"
                                variant="primary">
                                {{ $tc('supplier.priceUpdate.wizard.buttonConfirmAll') }}
                            </sw-button>

                            <div class="column-toggle-dropdown">
                                <sw-button size="small" @click="toggleColumnMenu = !toggleColumnMenu">
                                    <sw-icon name="regular-eye" size="16px" />
                                    Колонки
                                    <sw-icon :name="toggleColumnMenu ? 'regular-chevron-up-xs' : 'regular-chevron-down-xs'" size="12px" />
                                </sw-button>

                                <div v-if="toggleColumnMenu" class="column-menu">
                                    <div
                                        v-for="column in matchPreviewColumns.filter(c => c.property !== 'row_number')"
                                        :key="column.property"
                                        @click="toggleColumnVisibility(column.property)"
                                        class="column-menu-item">
                                        <sw-icon
                                            :name="isColumnVisible(column.property) ? 'regular-checkmark-xs' : 'regular-times-xs'"
                                            size="16px"
                                            :color="isColumnVisible(column.property) ? '#37d046' : '#de294c'"
                                        />
                                        <span>{{ column.label }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <sw-data-grid
                            :dataSource="matchPreviewData"
                            :columns="visibleMatchPreviewColumns"
                            :showSelection="false"
                            :showActions="false"
                            :isLoading="isLoadingMatchPreview"
                            :allowInlineEdit="false"
                            :allowColumnEdit="false"
                        >
                            <template #pagination>
                                <sw-pagination
                                    :page="previewPage"
                                    :limit="matchPreviewLimit"
                                    :total="previewTotal"
                                    :total-visible="7"
                                    @page-change="onPreviewPageChange"
                                />
                            </template>
                            <template #column-row_number="{ item }">
                                {{ item.row_number }}
                            </template>
                            <template #column-product_name="{ item }">
                                <router-link
                                    v-if="item.product_id"
                                    :to="{ name: 'sw.product.detail', params: { id: item.product_id } }"
                                    target="_blank"
                                    class="product-name-link">
                                    {{ item.product_name || '-' }}
                                </router-link>
                                <span v-else>{{ item.product_name || '-' }}</span>
                            </template>
                            <template #column-status="{ item }">
                                <sw-label
                                    :variant="item.status === 'matched' ? 'success' : (item.status === 'auto_matched' ? 'neutral' : (item.status === 'edited' ? 'info' : 'warning'))"
                                    size="small">
                                    {{ item.status === 'matched' ? 'Найден' : (item.status === 'auto_matched' ? 'Автоподбор' : (item.status === 'edited' ? 'Отредактирован' : 'Не найден')) }}
                                    <span v-if="item.status === 'auto_matched' && item.score" style="margin-left: 4px; opacity: 0.7">
                                        ({{ item.score }})
                                    </span>
                                </sw-label>
                            </template>
                            <template #column-current_kod_postavschika="{ item }">
                                {{ item.current_kod_postavschika || '-' }}
                            </template>
                            <template #column-supplier_code="{ item }">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <sw-text-field
                                        v-model="item.supplier_code"
                                        @change="onSupplierCodeChange(item, item.supplier_code)"
                                        size="small"
                                        borderless
                                        style="flex: 1;"
                                    ></sw-text-field>

                                    <template v-if="item.status === 'auto_matched'">
                                        <sw-icon
                                            name="solid-check-circle"
                                            size="16px"
                                            color="#37d046"
                                            style="cursor: pointer;"
                                            @click="confirmAutoMatch(item)"
                                            title="Подтвердить автоподбор">
                                        </sw-icon>
                                        <sw-icon
                                            name="solid-times-circle"
                                            size="16px"
                                            color="#de294c"
                                            style="cursor: pointer;"
                                            @click="rejectAutoMatch(item)"
                                            title="Отклонить автоподбор">
                                        </sw-icon>
                                    </template>
                                </div>
                            </template>
                            <template #column-supplier_name="{ item }">
                                {{ item.supplier_name || '-' }}
                            </template>
                            <template #column-prices="{ item }">
                                <div v-if="item.new_prices && (item.new_prices.purchase || item.new_prices.retail || item.new_prices.list)" class="price-display">
                                    <div v-if="item.new_prices.purchase" class="price-item">
                                        <span class="price-label">Зак:</span>
                                        <span :class="getPriceChangeClass(item.current_prices?.purchase, item.new_prices.purchase)" class="price-value">
                                            {{ formatPrice(item.new_prices.purchase) }}
                                        </span>
                                        <span v-if="item.current_prices?.purchase != null" class="price-old">
                                            {{ formatPrice(item.current_prices.purchase) }}
                                        </span>
                                    </div>
                                    <div v-if="item.new_prices.retail" class="price-item">
                                        <span class="price-label">Розн:</span>
                                        <span :class="getPriceChangeClass(item.current_prices?.retail, item.new_prices.retail)" class="price-value">
                                            {{ formatPrice(item.new_prices.retail) }}
                                        </span>
                                        <span v-if="item.current_prices?.retail != null" class="price-old">
                                            {{ formatPrice(item.current_prices.retail) }}
                                        </span>
                                    </div>
                                    <div v-if="item.new_prices.list" class="price-item">
                                        <span class="price-label">Прайс:</span>
                                        <span :class="getPriceChangeClass(item.current_prices?.list, item.new_prices.list)" class="price-value">
                                            {{ formatPrice(item.new_prices.list) }}
                                        </span>
                                        <span v-if="item.current_prices?.list != null" class="price-old">
                                            {{ formatPrice(item.current_prices.list) }}
                                        </span>
                                    </div>
                                </div>
                                <span v-else class="price-empty">-</span>
                            </template>
                            <template #column-availability="{ item }">
                                <span v-if="template.config.filters.availability_action === 'dont_change'">
                                    {{ item.current_stock || 0 }}
                                </span>
                                <span v-else-if="template.config.filters.availability_action === 'set_1000'">
                                    1000
                                </span>
                                <span v-else-if="template.config.filters.availability_action === 'set_from_price'">
                                    {{ (item.availability !== null && item.availability !== undefined) ? item.availability : 0 }}
                                </span>
                                <span v-else>-</span>
                            </template>
                        </sw-data-grid>

                        <sw-button
                            variant="primary"
                            @click="applyPrices"
                            :isLoading="isApplyingPrices">
                            {{ $tc('supplier.priceUpdate.wizard.buttonApplyPrices') }}
                        </sw-button>
                    </sw-card>
                    
                    <sw-card
                        v-else-if="matchPreviewData && matchPreviewData.length === 0"
                        :title="$tc('supplier.priceUpdate.wizard.step3PreviewTitle')"
                        class="preview-table-card">
                        <sw-empty-state
                            :title="$tc('supplier.priceUpdate.wizard.emptyMatchPreviewTitle')"
                            :subline="$tc('supplier.priceUpdate.wizard.emptyMatchPreviewDescription')"
                            icon="regular-file-text"
                        />
                    </sw-card>
                </div>
            </div>
        </template>
    </sw-page>
{% endblock %}
