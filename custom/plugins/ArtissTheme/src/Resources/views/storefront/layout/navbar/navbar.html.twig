{% sw_extends '@Storefront/storefront/layout/navbar/navbar.html.twig' %}

{% block layout_navbar_menu_home %}{% endblock %}

{% block layout_navbar_menu_items %}
    {% set currentRoute = app.request.attributes.get('_route') %}
    {% if currentRoute != 'frontend.home.page' %}
        {% set rootCategoryId = app.request.attributes.get('rootCategoryId') %}
        {% set navigationRootId = context.salesChannel.navigationCategoryId %}
        
        {% if not rootCategoryId %}
            {% set navigationId = app.request.attributes.get('navigationId') %}
            {% if navigationId %}
                {% for treeItem in header.navigation.tree %}
                    {% if navigationId == treeItem.category.id %}
                        {% set rootCategoryId = treeItem.category.id %}
                        {% break %}
                    {% endif %}
                    {% for childItem in treeItem.children %}
                        {% set childPath = childItem.category.path ?: '' %}
                        {% if navigationId == childItem.category.id or (childPath != '' and ('|' ~ navigationId ~ '|') in ('|' ~ childPath ~ '|')) %}
                            {% set rootCategoryId = treeItem.category.id %}
                            {% break %}
                        {% endif %}
                        {% for grandChildItem in childItem.children %}
                            {% set grandChildPath = grandChildItem.category.path ?: '' %}
                            {% if navigationId == grandChildItem.category.id or (grandChildPath != '' and ('|' ~ navigationId ~ '|') in ('|' ~ grandChildPath ~ '|')) %}
                                {% set rootCategoryId = treeItem.category.id %}
                                {% break %}
                            {% endif %}
                        {% endfor %}
                        {% if rootCategoryId %}
                            {% break %}
                        {% endif %}
                    {% endfor %}
                    {% if rootCategoryId %}
                        {% break %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endif %}
        
        {% set itemsToShow = [] %}
        
        {% if rootCategoryId %}
            {% for treeItem in header.navigation.tree %}
                {% if treeItem.category.id == rootCategoryId %}
                    {% set itemsToShow = treeItem.children %}
                    {% break %}
                {% endif %}
                {% for childItem in treeItem.children %}
                    {% if childItem.category.id == rootCategoryId %}
                        {% set itemsToShow = childItem.children %}
                        {% break %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% else %}
            {% for treeItem in header.navigation.tree %}
                {% if treeItem.category.id == context.salesChannel.navigationCategoryId %}
                    {% set itemsToShow = treeItem.children %}
                    {% break %}
                {% endif %}
            {% endfor %}
            {% if itemsToShow is empty %}
                {% for treeItem in header.navigation.tree %}
                    {% if treeItem.category.id != context.salesChannel.navigationCategoryId %}
                        {% set itemsToShow = itemsToShow|merge([treeItem]) %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endif %}
        
        {% for childItem in itemsToShow %}
            {% set childCategory = childItem.category %}
            {% set childId = childCategory.id %}
            {% set childName = childCategory.translated.name %}
            {% set childHasChildren = childItem.children|length > 0 %}
            {% set itemSkipped = childCategory.type == 'folder' and not childHasChildren %}

            {% if not itemSkipped %}
                {% block layout_navbar_menu_item %}
                    <li class="nav-item nav-item-{{ childId }} dropdown position-static">
                        {% block layout_navbar_menu_item_link %}
                            <a class="nav-link nav-item-{{ childId }}-link root main-navigation-link p-2 {% if childHasChildren %}dropdown-toggle{% else %}no-dropdown{% endif %}"
                               href="{{ childCategory.seoUrl ?: '#' }}"
                               {% if childHasChildren %}data-bs-toggle="dropdown"{% endif %}
                               {% if childCategory.type != 'folder' and childCategory.shouldOpenInNewTab %}target="_blank"{% endif %}
                               itemprop="url"
                               title="{{ childName }}"
                            >
                                {% block layout_navbar_menu_item_link_content %}
                                    <span itemprop="name" class="main-navigation-link-text">{{ childName }}</span>
                                {% endblock %}
                            </a>
                        {% endblock %}

                        {% if childHasChildren %}
                            {% block layout_navbar_menu_item_children %}
                                <div class="dropdown-menu w-100 p-4">
                                    {% sw_include '@Storefront/storefront/layout/navbar/content.html.twig' with {
                                        themeIconConfig: themeIconConfig,
                                        navigationTree: childItem,
                                        level: level+1,
                                        page: page
                                    } only %}
                                </div>
                            {% endblock %}
                        {% endif %}
                    </li>
                {% endblock %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endblock %}