{% block artiss_tools_backups %}
<sw-page class="artiss-tools-backups">
    {% block artiss_tools_backups_header %}
        <template #smart-bar-header>
            <h2>
                <router-link
                        :to="{ name: 'artiss.tools.index' }"
                        class="smart-bar__back-btn"
                >
                    <sw-icon name="regular-chevron-left" small></sw-icon>
                </router-link>
                {{ $tc('artissTools.backups.title') }}
            </h2>
        </template>
    {% endblock %}

    <template #content>
        <sw-tabs 
            class="sw-tabs--small artiss-tools__tabs" 
            @new-item-active="onTabChange" 
            :default-item="activeTab"
        >
            <sw-tabs-item name="create" :active-tab="activeTab">
                {{ $tc('artissTools.backups.tabs.create') }}
            </sw-tabs-item>
            <sw-tabs-item name="restore" :active-tab="activeTab">
                {{ $tc('artissTools.backups.tabs.restore') }}
            </sw-tabs-item>
        </sw-tabs>

        {# Create Tab #}
        <template v-if="activeTab === 'create'">

            {# Database Backup Block #}
            <sw-card
                :title="$tc('artissTools.backups.create.dbBackup.title')"
            >
                <div class="artiss-backup-form">
                    <sw-single-select
                        v-model:value="dbBackup.type"
                        :options="dbTypeOptions"
                        :label="$tc('artissTools.backups.create.dbBackup.type')"
                        valueProperty="value"
                        labelProperty="label"
                    />

                    {# Smart backup excluded tables info #}
                    <sw-alert v-if="dbBackup.type === 'smart'" variant="info" class="artiss-smart-tables-info">
                        <strong>{{ $tc('artissTools.backups.create.dbBackup.excludedTables') }}:</strong>
                        <div class="artiss-smart-tables-list">
                            <span v-for="table in smartExcludedTables" :key="table" class="artiss-smart-tables-list__item">
                                {{ table }}
                            </span>
                        </div>
                    </sw-alert>

                    <sw-text-field
                        v-model:value="dbBackup.outputDir"
                        :label="$tc('artissTools.backups.create.dbBackup.outputDir')"
                        :helpText="pluginConfig.dbOutputDirFull"
                        :placeholder="pluginConfig.dbOutputDir"
                    />

                    <sw-checkbox-field
                        v-model:value="dbBackup.gzip"
                        :label="$tc('artissTools.backups.create.dbBackup.gzip')"
                    />

                    <sw-textarea-field
                        v-model:value="dbBackup.comment"
                        :label="$tc('artissTools.backups.create.dbBackup.comment')"
                        :placeholder="$tc('artissTools.backups.create.dbBackup.commentPlaceholder')"
                        :helpText="$tc('artissTools.backups.create.commentHelp')"
                        @update:value="(value) => { console.log('Comment updated:', value); dbBackup.comment = value; }"
                    />

                    {# Progress bar #}
                    <div v-if="isDbBackupLoading && dbBackupProgress > 0" class="artiss-backup-progress">
                        <sw-progress-bar :value="dbBackupProgress" />
                        <p class="artiss-backup-progress__text">{{ dbBackupProgress }}% - Creating backup...</p>
                    </div>

                    {# Create button #}
                    <sw-button
                        variant="primary"
                        :disabled="isDbBackupLoading"
                        @click="createDbBackup"
                        block
                    >
                        <sw-icon name="regular-database" small />
                        {{ $tc('artissTools.backups.create.dbBackup.button') }}
                    </sw-button>
                </div>
            </sw-card>

            {# Media Backup Block #}
            <sw-card
                :title="$tc('artissTools.backups.create.mediaBackup.title')"
            >
                <div class="artiss-backup-form">
                    <sw-single-select
                        v-model:value="mediaBackup.scope"
                        :options="mediaScopeOptions"
                        :label="$tc('artissTools.backups.create.mediaBackup.scope')"
                        valueProperty="value"
                        labelProperty="label"
                    />

                    <sw-text-field
                        v-model:value="mediaBackup.outputDir"
                        :label="$tc('artissTools.backups.create.mediaBackup.outputDir')"
                        :helpText="pluginConfig.mediaOutputDirFull"
                        :placeholder="pluginConfig.mediaOutputDir"
                    />

                    <sw-checkbox-field
                        v-model:value="mediaBackup.compress"
                        :label="$tc('artissTools.backups.create.mediaBackup.compress')"
                        :helpText="$tc('artissTools.backups.create.mediaBackup.compressHelp')"
                    />

                    <sw-checkbox-field
                        v-model:value="mediaBackup.excludeThumbnails"
                        :label="$tc('artissTools.backups.create.mediaBackup.excludeThumbnails')"
                    />

                    <sw-textarea-field
                        v-model:value="mediaBackup.comment"
                        :label="$tc('artissTools.backups.create.mediaBackup.comment')"
                        :placeholder="$tc('artissTools.backups.create.mediaBackup.commentPlaceholder')"
                        :helpText="$tc('artissTools.backups.create.commentHelp')"
                        @update:value="(value) => { console.log('Media comment updated:', value); mediaBackup.comment = value; }"
                    />

                    {# Progress bar #}
                    <div v-if="isMediaBackupLoading && mediaBackupProgress > 0" class="artiss-backup-progress">
                        <sw-progress-bar :value="mediaBackupProgress" />
                        <p class="artiss-backup-progress__text">{{ mediaBackupProgress }}% - Creating backup...</p>
                    </div>

                    {# Create button #}
                    <sw-button
                        variant="primary"
                        :disabled="isMediaBackupLoading"
                        @click="createMediaBackup"
                        block
                    >
                        <sw-icon name="regular-image" small />
                        {{ $tc('artissTools.backups.create.mediaBackup.button') }}
                    </sw-button>
                </div>
            </sw-card>

            {# Storage Path Info #}
            <sw-card v-if="pluginConfig.projectDir" class="artiss-path-card">
                <sw-alert variant="info" class="artiss-path-info">
                    <strong>{{ $tc('artissTools.backups.create.storagePath') }}:</strong>
                    <code>{{ pluginConfig.projectDir }}/{{ pluginConfig.backupPath }}</code>
                    <br>
                    {{ $tc('artissTools.backups.create.dbBackup.keep') }}: <strong>{{ pluginConfig.backupRetention }}</strong>
                    <br>
                    <small>{{ $tc('artissTools.backups.create.retentionInfo') }}</small>
                </sw-alert>
            </sw-card>
        </template>

        {# Restore Tab #}
        <template v-else>
            {# Database Backups List #}
            <sw-card 
                :title="$tc('artissTools.backups.restore.dbBackups.title')"
                :isLoading="isLoadingDbList"
            >
                <template v-if="dbBackupsList.length > 0">
                    <table class="artiss-backups-table">
                        <thead>
                            <tr>
                                <th>{{ $tc('artissTools.backups.restore.table.type') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.filename') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.size') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.createdAt') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.comment') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.actions') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="backup in dbBackupsList" :key="backup.id" :class="{ 'artiss-backups-table__row--missing': !backup.exists }">
                                <td><strong>{{ backup.type }}</strong></td>
                                <td class="artiss-backups-table__filename">{{ backup.filename }}</td>
                                <td>{{ backup.sizeFormatted }}</td>
                                <td>{{ backup.createdAt }}</td>
                                <td>{{ backup.comment || '-' }}</td>
                                <td class="artiss-backups-table__actions">
                                    <div v-if="backup.exists" class="artiss-backups-table__buttons">
                                        <sw-button
                                            variant="primary"
                                            size="small"
                                            @click.stop.native="openDbRestoreModal(backup)"
                                        >
                                            {{ $tc('artissTools.backups.restore.buttons.restore') }}
                                        </sw-button>
                                        <sw-button
                                            variant="secondary"
                                            size="small"
                                            @click.stop.native="downloadBackup(backup)"
                                        >
                                            <sw-icon name="regular-download" small />
                                        </sw-button>
                                        <sw-button
                                            variant="danger"
                                            size="small"
                                            @click.stop.native="confirmDeleteBackup(backup, 'db')"
                                        >
                                            <sw-icon name="regular-trash" small />
                                        </sw-button>
                                    </div>
                                    <span v-else class="artiss-backups-table__missing">
                                        {{ $tc('artissTools.backups.restore.fileMissing') }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </template>
                <template v-else>
                    <sw-alert variant="info">
                        {{ $tc('artissTools.backups.restore.noBackups') }}
                    </sw-alert>
                </template>
        </sw-card>

            {# Media Backups List #}
            <sw-card 
                :title="$tc('artissTools.backups.restore.mediaBackups.title')"
                :isLoading="isLoadingMediaList"
            >
                <template v-if="mediaBackupsList.length > 0">
                    <table class="artiss-backups-table">
                        <thead>
                            <tr>
                                <th>{{ $tc('artissTools.backups.restore.table.scope') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.filename') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.size') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.createdAt') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.comment') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.actions') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="backup in mediaBackupsList" :key="backup.id" :class="{ 'artiss-backups-table__row--missing': !backup.exists }">
                                <td><strong>{{ backup.type }}</strong></td>
                                <td class="artiss-backups-table__filename">{{ backup.filename }}</td>
                                <td>{{ backup.sizeFormatted }}</td>
                                <td>{{ backup.createdAt }}</td>
                                <td>{{ backup.comment || '-' }}</td>
                                <td class="artiss-backups-table__actions">
                                    <div v-if="backup.exists" class="artiss-backups-table__buttons">
                                        <sw-button
                                            variant="primary"
                                            size="small"
                                            @click.stop.native="openMediaRestoreModal(backup)"
                                        >
                                            {{ $tc('artissTools.backups.restore.buttons.restore') }}
                                        </sw-button>
                                        <sw-button
                                            variant="secondary"
                                            size="small"
                                            @click.stop.native="downloadBackup(backup)"
                                        >
                                            <sw-icon name="regular-download" small />
                                        </sw-button>
                                        <sw-button
                                            variant="danger"
                                            size="small"
                                            @click.stop.native="confirmDeleteBackup(backup, 'media')"
                                        >
                                            <sw-icon name="regular-trash" small />
                                        </sw-button>
                                    </div>
                                    <span v-else class="artiss-backups-table__missing">
                                        {{ $tc('artissTools.backups.restore.fileMissing') }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </template>
                <template v-else>
                    <sw-alert variant="info">
                        {{ $tc('artissTools.backups.restore.noBackups') }}
                    </sw-alert>
                </template>
        </sw-card>
        </template>

    {# DB Restore Modal #}
    <sw-modal
        v-if="showDbRestoreModal"
        :title="$tc('artissTools.backups.restore.dbRestore.title')"
        variant="default"
        @modal-close="closeDbRestoreModal"
    >
        <sw-alert variant="warning" class="artiss-restore-warning">
            {{ $tc('artissTools.backups.restore.dbRestore.warning') }}
        </sw-alert>

        <div class="artiss-restore-info" v-if="selectedDbBackup">
            <p><strong>{{ $tc('artissTools.backups.restore.table.filename') }}:</strong> {{ selectedDbBackup.filename }}</p>
            <p><strong>{{ $tc('artissTools.backups.restore.table.size') }}:</strong> {{ selectedDbBackup.sizeFormatted }}</p>
            <p><strong>{{ $tc('artissTools.backups.restore.table.type') }}:</strong> {{ selectedDbBackup.type }}</p>
        </div>

        <sw-checkbox-field
            v-model:value="dbRestoreOptions.dropTables"
            :label="$tc('artissTools.backups.restore.dbRestore.dropTables')"
        />

        <sw-text-field
            v-model:value="dbRestoreConfirmation"
            :label="$tc('artissTools.backups.restore.dbRestore.confirmLabel')"
            :placeholder="$tc('artissTools.backups.restore.dbRestore.confirmPlaceholder')"
        />

        <template #modal-footer>
            <sw-button
                variant="secondary"
                @click="closeDbRestoreModal"
            >
                {{ $tc('artissTools.backups.restore.buttons.cancel') }}
            </sw-button>

            <sw-button
                variant="danger"
                :disabled="!canRestoreDb || isDbRestoring"
                :isLoading="isDbRestoring"
                @click="restoreDb"
            >
                {{ $tc('artissTools.backups.restore.dbRestore.button') }}
            </sw-button>
        </template>
    </sw-modal>

    {# Media Restore Modal #}
    <sw-modal
        v-if="showMediaRestoreModal"
        :title="$tc('artissTools.backups.restore.mediaRestore.title')"
        variant="default"
        @modal-close="closeMediaRestoreModal"
    >
        <sw-alert variant="warning" class="artiss-restore-warning">
            {{ $tc('artissTools.backups.restore.mediaRestore.warning') }}
        </sw-alert>

        <div class="artiss-restore-info" v-if="selectedMediaBackup">
            <p><strong>{{ $tc('artissTools.backups.restore.table.filename') }}:</strong> {{ selectedMediaBackup.filename }}</p>
            <p><strong>{{ $tc('artissTools.backups.restore.table.size') }}:</strong> {{ selectedMediaBackup.sizeFormatted }}</p>
            <p><strong>{{ $tc('artissTools.backups.restore.table.scope') }}:</strong> {{ selectedMediaBackup.type }}</p>
        </div>

        <sw-single-select
            v-model:value="mediaRestoreOptions.mode"
            :options="mediaRestoreModeOptions"
            :label="$tc('artissTools.backups.restore.mediaRestore.mode')"
            valueProperty="value"
            labelProperty="label"
        />

        <sw-checkbox-field
            v-model:value="mediaRestoreConfirmed"
            :label="$tc('artissTools.backups.restore.mediaRestore.confirmCheckbox')"
        />

        <template #modal-footer>
            <sw-button
                variant="secondary"
                @click="closeMediaRestoreModal"
            >
                {{ $tc('artissTools.backups.restore.buttons.cancel') }}
            </sw-button>

            <sw-button
                variant="danger"
                :disabled="!canRestoreMedia || isMediaRestoring"
                :isLoading="isMediaRestoring"
                @click="restoreMedia"
            >
                {{ $tc('artissTools.backups.restore.mediaRestore.button') }}
            </sw-button>
        </template>
    </sw-modal>

    {# Delete Confirmation Modal #}
    <sw-modal
        v-if="showDeleteModal"
        :title="$tc('artissTools.backups.restore.deleteBackup.title')"
        variant="small"
        @modal-close="closeDeleteModal"
    >
        <sw-alert variant="warning" class="artiss-restore-warning">
            {{ $tc('artissTools.backups.restore.deleteBackup.warning') }}
        </sw-alert>

        <div class="artiss-restore-info" v-if="backupToDelete">
            <p><strong>{{ $tc('artissTools.backups.restore.table.filename') }}:</strong> {{ backupToDelete.filename }}</p>
            <p><strong>{{ $tc('artissTools.backups.restore.table.size') }}:</strong> {{ backupToDelete.sizeFormatted }}</p>
        </div>

        <template #modal-footer>
            <sw-button
                variant="secondary"
                @click="closeDeleteModal"
            >
                {{ $tc('artissTools.backups.restore.buttons.cancel') }}
            </sw-button>

            <sw-button
                variant="danger"
                :isLoading="isDeleting"
                @click="deleteBackup"
            >
                <sw-icon name="regular-trash" small />
                {{ $tc('artissTools.backups.restore.deleteBackup.button') }}
            </sw-button>
        </template>
    </sw-modal>
    </template>
</sw-page>
{% endblock %}
