{% block artiss_tools_backups %}
<sw-page class="artiss-tools-backups">
    {% block artiss_tools_backups_header %}
        <template #smart-bar-header>
            <h2>
                <router-link
                        :to="{ name: 'artiss.tools.index' }"
                        class="smart-bar__back-btn"
                >
                    <sw-icon name="regular-chevron-left" small></sw-icon>
                </router-link>
                {{ $tc('artissTools.backups.title') }}
            </h2>
        </template>
    {% endblock %}

    <template #content>
        <sw-tabs 
            class="sw-tabs--small artiss-tools__tabs" 
            @new-item-active="onTabChange" 
            :default-item="activeTab"
        >
            <sw-tabs-item name="create" :active-tab="activeTab">
                {{ $tc('artissTools.backups.tabs.create') }}
            </sw-tabs-item>
            <sw-tabs-item name="restore" :active-tab="activeTab">
                {{ $tc('artissTools.backups.tabs.restore') }}
            </sw-tabs-item>
        </sw-tabs>

        {# Create Tab #}
        <template v-if="activeTab === 'create'">
            {# Storage Path Info #}
            <sw-card v-if="pluginConfig.projectDir" class="artiss-path-card">
                <sw-alert variant="info" class="artiss-path-info">
                    <strong>{{ $tc('artissTools.backups.create.storagePath') }}:</strong>
                    <code>{{ pluginConfig.projectDir }}/{{ pluginConfig.backupPath }}</code>
                </sw-alert>
            </sw-card>

            {# Database Backup Block #}
            <sw-card 
                :title="$tc('artissTools.backups.create.dbBackup.title')"
                :isLoading="isDbBackupLoading"
            >
                <div class="artiss-backup-form">
                    <sw-single-select
                        v-model:value="dbBackup.type"
                        :options="dbTypeOptions"
                        :label="$tc('artissTools.backups.create.dbBackup.type')"
                        valueProperty="value"
                        labelProperty="label"
                    />

                    <sw-text-field
                        v-model:value="dbBackup.outputDir"
                        :label="$tc('artissTools.backups.create.dbBackup.outputDir')"
                        :helpText="pluginConfig.dbOutputDirFull"
                        :placeholder="pluginConfig.dbOutputDir"
                    />

                    <sw-number-field
                        v-model:value="dbBackup.keep"
                        :label="$tc('artissTools.backups.create.dbBackup.keep')"
                        :min="1"
                        :max="100"
                    />

                    <sw-checkbox-field
                        v-model:value="dbBackup.gzip"
                        :label="$tc('artissTools.backups.create.dbBackup.gzip')"
                    />

                    <sw-textarea-field
                        v-model:value="dbBackup.comment"
                        :label="$tc('artissTools.backups.create.dbBackup.comment')"
                        :placeholder="$tc('artissTools.backups.create.dbBackup.commentPlaceholder')"
                    />
                </div>

                <template #toolbar>
                    <sw-button
                        variant="primary"
                        :disabled="isDbBackupLoading"
                        @click="createDbBackup"
                    >
                        <sw-icon name="regular-database" small />
                        {{ $tc('artissTools.backups.create.dbBackup.button') }}
                    </sw-button>
                </template>
            </sw-card>

            {# Last DB Backup Info #}
            <sw-card 
                v-if="lastDbBackup"
                :title="$tc('artissTools.backups.create.lastBackup.title')"
            >
                <table class="artiss-result-table">
                    <tbody>
                        <tr>
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.type') }}</td>
                            <td><strong>{{ lastDbBackup.type }}</strong></td>
                        </tr>
                        <tr>
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.filename') }}</td>
                            <td>{{ lastDbBackup.filename }}</td>
                        </tr>
                        <tr>
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.size') }}</td>
                            <td>{{ lastDbBackup.sizeFormatted }}</td>
                        </tr>
                        <tr>
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.createdAt') }}</td>
                            <td>{{ lastDbBackup.createdAt }}</td>
                        </tr>
                        <tr v-if="lastDbBackup.comment">
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.comment') }}</td>
                            <td>{{ lastDbBackup.comment }}</td>
                        </tr>
                    </tbody>
                </table>
            </sw-card>

            {# Media Backup Block #}
            <sw-card 
                :title="$tc('artissTools.backups.create.mediaBackup.title')"
                :isLoading="isMediaBackupLoading"
            >
                <div class="artiss-backup-form">
                    <sw-single-select
                        v-model:value="mediaBackup.scope"
                        :options="mediaScopeOptions"
                        :label="$tc('artissTools.backups.create.mediaBackup.scope')"
                        valueProperty="value"
                        labelProperty="label"
                    />

                    <sw-text-field
                        v-model:value="mediaBackup.outputDir"
                        :label="$tc('artissTools.backups.create.mediaBackup.outputDir')"
                        :helpText="pluginConfig.mediaOutputDirFull"
                        :placeholder="pluginConfig.mediaOutputDir"
                    />

                    <sw-number-field
                        v-model:value="mediaBackup.keep"
                        :label="$tc('artissTools.backups.create.mediaBackup.keep')"
                        :min="1"
                        :max="100"
                    />

                    <sw-checkbox-field
                        v-model:value="mediaBackup.compress"
                        :label="$tc('artissTools.backups.create.mediaBackup.compress')"
                        :helpText="$tc('artissTools.backups.create.mediaBackup.compressHelp')"
                    />

                    <sw-checkbox-field
                        v-model:value="mediaBackup.excludeThumbnails"
                        :label="$tc('artissTools.backups.create.mediaBackup.excludeThumbnails')"
                    />

                    <sw-textarea-field
                        v-model:value="mediaBackup.comment"
                        :label="$tc('artissTools.backups.create.mediaBackup.comment')"
                        :placeholder="$tc('artissTools.backups.create.mediaBackup.commentPlaceholder')"
                    />
                </div>

                <template #toolbar>
                    <sw-button
                        variant="primary"
                        :disabled="isMediaBackupLoading"
                        @click="createMediaBackup"
                    >
                        <sw-icon name="regular-image" small />
                        {{ $tc('artissTools.backups.create.mediaBackup.button') }}
                    </sw-button>
                </template>
            </sw-card>

            {# Last Media Backup Info #}
            <sw-card 
                v-if="lastMediaBackup"
                :title="$tc('artissTools.backups.create.lastMediaBackup.title')"
            >
                <table class="artiss-result-table">
                    <tbody>
                        <tr>
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.scope') }}</td>
                            <td><strong>{{ lastMediaBackup.type }}</strong></td>
                        </tr>
                        <tr>
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.filename') }}</td>
                            <td>{{ lastMediaBackup.filename }}</td>
                        </tr>
                        <tr>
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.size') }}</td>
                            <td>{{ lastMediaBackup.sizeFormatted }}</td>
                        </tr>
                        <tr>
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.createdAt') }}</td>
                            <td>{{ lastMediaBackup.createdAt }}</td>
                        </tr>
                        <tr v-if="lastMediaBackup.comment">
                            <td class="artiss-result-table__label">{{ $tc('artissTools.backups.create.lastBackup.comment') }}</td>
                            <td>{{ lastMediaBackup.comment }}</td>
                        </tr>
                    </tbody>
                </table>
            </sw-card>
        </template>

        {# Restore Tab #}
        <template v-else>
            {# Database Backups List #}
            <sw-card 
                :title="$tc('artissTools.backups.restore.dbBackups.title')"
                :isLoading="isLoadingDbList"
            >
                <template v-if="dbBackupsList.length > 0">
                    <table class="artiss-backups-table">
                        <thead>
                            <tr>
                                <th>{{ $tc('artissTools.backups.restore.table.type') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.filename') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.size') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.createdAt') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.comment') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.actions') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="backup in dbBackupsList" :key="backup.id" :class="{ 'artiss-backups-table__row--missing': !backup.exists }">
                                <td><strong>{{ backup.type }}</strong></td>
                                <td class="artiss-backups-table__filename">{{ backup.filename }}</td>
                                <td>{{ backup.sizeFormatted }}</td>
                                <td>{{ backup.createdAt }}</td>
                                <td>{{ backup.comment || '-' }}</td>
                                <td>
                                    <sw-button
                                        v-if="backup.exists"
                                        variant="ghost"
                                        size="small"
                                        @click="openDbRestoreModal(backup)"
                                    >
                                        {{ $tc('artissTools.backups.restore.buttons.restore') }}
                                    </sw-button>
                                    <span v-else class="artiss-backups-table__missing">
                                        {{ $tc('artissTools.backups.restore.fileMissing') }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </template>
                <template v-else>
                    <sw-alert variant="info">
                        {{ $tc('artissTools.backups.restore.noBackups') }}
                    </sw-alert>
                </template>
        </sw-card>

            {# Media Backups List #}
            <sw-card 
                :title="$tc('artissTools.backups.restore.mediaBackups.title')"
                :isLoading="isLoadingMediaList"
            >
                <template v-if="mediaBackupsList.length > 0">
                    <table class="artiss-backups-table">
                        <thead>
                            <tr>
                                <th>{{ $tc('artissTools.backups.restore.table.scope') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.filename') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.size') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.createdAt') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.comment') }}</th>
                                <th>{{ $tc('artissTools.backups.restore.table.actions') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="backup in mediaBackupsList" :key="backup.id" :class="{ 'artiss-backups-table__row--missing': !backup.exists }">
                                <td><strong>{{ backup.type }}</strong></td>
                                <td class="artiss-backups-table__filename">{{ backup.filename }}</td>
                                <td>{{ backup.sizeFormatted }}</td>
                                <td>{{ backup.createdAt }}</td>
                                <td>{{ backup.comment || '-' }}</td>
                                <td>
                                    <sw-button
                                        v-if="backup.exists"
                                        variant="ghost"
                                        size="small"
                                        @click="openMediaRestoreModal(backup)"
                                    >
                                        {{ $tc('artissTools.backups.restore.buttons.restore') }}
                                    </sw-button>
                                    <span v-else class="artiss-backups-table__missing">
                                        {{ $tc('artissTools.backups.restore.fileMissing') }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </template>
                <template v-else>
                    <sw-alert variant="info">
                        {{ $tc('artissTools.backups.restore.noBackups') }}
                    </sw-alert>
                </template>
        </sw-card>
        </template>
    </template>

    {# DB Restore Modal #}
    <sw-modal
        v-if="showDbRestoreModal"
        :title="$tc('artissTools.backups.restore.dbRestore.title')"
        variant="default"
        @modal-close="closeDbRestoreModal"
    >
        <sw-alert variant="warning" class="artiss-restore-warning">
            {{ $tc('artissTools.backups.restore.dbRestore.warning') }}
        </sw-alert>

        <div class="artiss-restore-info" v-if="selectedDbBackup">
            <p><strong>{{ $tc('artissTools.backups.restore.table.filename') }}:</strong> {{ selectedDbBackup.filename }}</p>
            <p><strong>{{ $tc('artissTools.backups.restore.table.size') }}:</strong> {{ selectedDbBackup.sizeFormatted }}</p>
            <p><strong>{{ $tc('artissTools.backups.restore.table.type') }}:</strong> {{ selectedDbBackup.type }}</p>
        </div>

        <sw-checkbox-field
            v-model:value="dbRestoreOptions.dropTables"
            :label="$tc('artissTools.backups.restore.dbRestore.dropTables')"
        />

        <sw-text-field
            v-model:value="dbRestoreConfirmation"
            :label="$tc('artissTools.backups.restore.dbRestore.confirmLabel')"
            :placeholder="$tc('artissTools.backups.restore.dbRestore.confirmPlaceholder')"
        />

        <template #modal-footer>
            <sw-button
                variant="secondary"
                @click="closeDbRestoreModal"
            >
                {{ $tc('artissTools.backups.restore.buttons.cancel') }}
            </sw-button>

            <sw-button
                variant="danger"
                :disabled="!canRestoreDb || isDbRestoring"
                :isLoading="isDbRestoring"
                @click="restoreDb"
            >
                {{ $tc('artissTools.backups.restore.dbRestore.button') }}
            </sw-button>
        </template>
    </sw-modal>

    {# Media Restore Modal #}
    <sw-modal
        v-if="showMediaRestoreModal"
        :title="$tc('artissTools.backups.restore.mediaRestore.title')"
        variant="default"
        @modal-close="closeMediaRestoreModal"
    >
        <sw-alert variant="warning" class="artiss-restore-warning">
            {{ $tc('artissTools.backups.restore.mediaRestore.warning') }}
        </sw-alert>

        <div class="artiss-restore-info" v-if="selectedMediaBackup">
            <p><strong>{{ $tc('artissTools.backups.restore.table.filename') }}:</strong> {{ selectedMediaBackup.filename }}</p>
            <p><strong>{{ $tc('artissTools.backups.restore.table.size') }}:</strong> {{ selectedMediaBackup.sizeFormatted }}</p>
            <p><strong>{{ $tc('artissTools.backups.restore.table.scope') }}:</strong> {{ selectedMediaBackup.type }}</p>
        </div>

        <sw-single-select
            v-model:value="mediaRestoreOptions.mode"
            :options="mediaRestoreModeOptions"
            :label="$tc('artissTools.backups.restore.mediaRestore.mode')"
            valueProperty="value"
            labelProperty="label"
        />

        <sw-checkbox-field
            v-model:value="mediaRestoreConfirmed"
            :label="$tc('artissTools.backups.restore.mediaRestore.confirmCheckbox')"
        />

        <template #modal-footer>
            <sw-button
                variant="secondary"
                @click="closeMediaRestoreModal"
            >
                {{ $tc('artissTools.backups.restore.buttons.cancel') }}
            </sw-button>

            <sw-button
                variant="danger"
                :disabled="!canRestoreMedia || isMediaRestoring"
                :isLoading="isMediaRestoring"
                @click="restoreMedia"
            >
                {{ $tc('artissTools.backups.restore.mediaRestore.button') }}
            </sw-button>
        </template>
    </sw-modal>
</sw-page>
{% endblock %}
